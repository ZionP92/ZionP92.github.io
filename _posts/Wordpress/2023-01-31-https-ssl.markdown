---
layout: post
title: 무료 SSL 인증서로 https 사용하기
date: 2023-01-31 12:11:57 +0900
category: Wordpress
---

앞선 포스트들에 이어 Let's Encrypt의 인증서를 사용하였으므로 다른 환경 구성들은 동일하다.
구글링을 해보면 보통 Nginx를 많이쓰지만 이미 아파치를 쓰고있으니 그에 맞는 패키지를 설치 하도록 한다.

```sh
sudo apt install certbot python3-certbot-apache
```

<br />

설치가 끝나면 인증서를 생성한다. 생성 과정에서 나오는 프롬트는 이메일하고 라이선스 동의서 뭐 그런 것들인데 맞게 적어주고 동의하면 된다. 도메인 여러 개를 한 사이트에서 쓰고 있다면 도메인 적는 란에 다 적어주면 인증서가 같이 다 발행된다. 중간에 나오는 리다이렉트 옵션은 전부 https로 리다이렉트하게 만들었지만 경우에 따라 그렇게 신뢰성이 높지는 않다는 얘기들이 있다. 따로 방법을 찾아 처리하면 더 좋을 것 같다. 워드프레스는 플러그인으로도 가능하다.

```sh
sudo certbot --apache
```

<br />

필자는 기본으로 해서 따로 .conf 들을 건드리지는 않았지만 대개의 경우에 사이트 주소로 된 .conf 파일들을 사용하는 것 같다. 어차피 사이트 하나 돌리는 것 말고는 분할하지 않을 계획이라 그냥 그대로 쓰려한다.

<br />

너무 내용이 적으니 추가로 인증서 확인과 삭제 방법 그리고 자동 갱신 설정 방법을 아래에 남긴다.

<br />

먼저 인증서 확인 방법이다. 여기에 유효기간도 같이 나온다.

```sh
sudo cerbot certificates
```

<br />

지우는 법은 아래와 같이 해도 되나 처음부터 하나를 타겟으로 지우는 두번째 방법도 있다. (tld는 top level domain으로 이 부분에 여러 개 도메인이 묶여있는 것의 대표 도메인을 적으면 됨)

```sh
sudo certbot delete
```

```sh
sudo certbot delete --cert-name tld
```

<br />

위와 같이 지우면 같은 도메인으로 재생성 할 때 에러가 뜰 것이다. 이유는 .conf 파일이 남아있어서 그런데 그걸 지워주면 된다. 내 경우엔 default를 사용하고 있으니 아래와 같다.

```sh
sudo rm /etc/apache2/sites-enabled/000-default-le-ssl.conf
```

<br />

도메인을 더 추가하고자 구글링을 했는데 추가는 새로 발행해야 한다는 이야기가 있어서 지우고 다시 했었다. 하지만 위와 같이 지우고 다시 생성하니 기본 리다이렉트 기능이 해제가 됐지만 어차피 플러그인을 사용하니 알아보지는 않았다. 하지만 지우고 생성하면 때마다 리다이렉트가 되는지 꼭 체크해야 할 것 같다.

<br />

유념해야 할 것은 Let's Encrypt는 3개월 주기로 만료가 된다. 메일이 오니 맞춰서 재발급해줘도 되지만 우분투의 기본 기능인 crontab으로 자동으로 갱신되도록 설정을 할 수도 있다.

<br />

먼저 갱신 방법이다. 확인만 하고 싶다면 --dry-run을 같이 적어주면 된다.

```sh
sudo certbot renew
```

<br />

먼저 서버의 시간을 확인하도록 하자.

```sh
date
```

<br />

crontab 편집을 연다. sudo로 열어야 인증서를 다룰 수 있다.

```sh
sudo crontab -e
```

<br />

안의 설명에 적힌대로 분, 시, 일, 월 ,요일, 커맨드 순이다. 필자는 매월 21일 오전 11시 정각에 갱신하도록 하였다. 서버 시간과 차이가 있어서 11을 2로 표기해 주었다. --deploy-hook은 갱신해야 할지 체크할 때는 건너뛰고 성공적일 때만 뒤의 명령어를 실행하게 된다. 따라서 실제로 갱신하였을 경우에만 아파치를 재시작 하도록 하였다.

```
0 2 21 * * /user/bin/certbot renew --deploy-hook="sudo systemctl restart apache2"
```

<br />

crontab에 적힌 명령어들을 확인하려면 아래와 같이 실행해 주면 된다.

```sh
sudo crontab -l
```